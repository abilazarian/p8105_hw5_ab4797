---
title: "Homework 5"
author: "Ani Bilazarian"
date: "11/8/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


# Problem 1 

_Read in IRIS data_

```{r}
set.seed(10)

iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))
```

_Function replacing NAs_

```{r}

missing_data = function(x)  {
  
  if(is.numeric(x)){
    x = replace_na(x, mean(x, na.rm = TRUE))
  } 
  else if (is.character(x)){
    x = replace_na(x, "virginica")
  
    }}
  
iris_with_missing =  map(iris_with_missing, missing_data) %>% 
  as_tibble()
```


# PROBLEM 2

_ Writing Function to Import Multiple Files at Once_ 


```{r, warning = FALSE, message= FALSE}
library(readxl)

files = list.files("./data", pattern = NULL, all.files = FALSE, full.names = FALSE) 

problem_2 = data_frame(filename = files) %>% 
mutate(file_contents = map(filename, ~ read_csv(file.path("./data", .)))) %>% 
separate("filename", into = c("control", "subject")) %>% 
  unnest(file_contents) %>% 
  mutate(control = recode(control, 'con' = "control", 'exp' =  "experimental"))
```

While we need to pivot longer in order to plot this dataset, I think it is easier to read and tidier to visualize weeks as columns in order to see the distribution over time. 


_Spaghetti Plot Separated by Face_Grid to show Control versus Experimental_

```{r}
problem_2 %>% 
pivot_longer(week_1:week_8, names_to = "week", names_prefix = "week_") %>% 
  ggplot(aes(x = week, y = value, group = subject, color = subject)) + geom_path() + labs(title = "Distribution of Observations Across Weeks") + facet_grid(~control) + viridis::scale_color_viridis(discrete = TRUE) + theme(legend.position = "bottom")
```

_Spaghetti Plot on one graph showing Control and Experimental_

```{r}
problem_2 %>% 
  pivot_longer(week_1:week_8, names_to = "week", names_prefix = "week_") %>% 
  ggplot(aes(x = week, y = value, group = subject, color = control)) + geom_path() + labs(title = "Distribution of Observations Across Weeks") + viridis::scale_color_viridis(discrete = TRUE) + theme(legend.position = "bottom")

```


# PROBLEM 3 

_Writing a function and loop for multiple betas_

```{r}
library(broom)
set.seed(17)

sim_regression = function(n = 30, beta0 = 2, beta1) {

    sim_data = tibble(
    x = rnorm(n, mean = 1, sd = 1),
    y = beta0 + beta1 * x + rnorm(n, 0, 50))
  
  ls_fit = lm(y ~ x, data = sim_data) %>% broom::tidy()

  ls_fit
}

sim_regression(30, 2, 0)

sim_results = 
  rerun(10000, sim_regression(30, 2, 0)) %>% 
  bind_rows() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable()
```


```{r}
beta_list = list("b_1"  = 1, 
              "b_2"  = 2, 
              "b_3" = 3, 
              "b_4" = 4,
              "b_5" = 5,
              "b_6" = 6
              )

output = vector("list", length = 6)

for (i in 1:6) {
  output[[i]] = rerun(10000, sim_regression(beta1 = beta_list[[i]])) %>% 
    bind_rows
}

sim_results = 
  tibble(beta1 = c(1, 2, 3, 4, 5, 6)) %>% 
  mutate(
    output_lists = map(.x = beta1, ~rerun(10000, sim_regression(beta1 = .x))),
    estimate_dfs = map(output_lists, bind_rows)) %>% 
  select(-output_lists) %>% 
  unnest(estimate_dfs)

sim_results = 
  sim_results %>% 
  filter(term == "x") %>% 
  select(beta1, term, estimate, p.value)
```

_Making two datasets to build proportion_

```{r}
sim_results = 
  sim_results %>% 
    mutate(reject = if_else(p.value < '0.05', '1', '0')) 

reject_count = 
    sim_results %>% 
  filter(reject == 1) %>% 
group_by(beta1) %>% 
  summarize(n = n()) %>% 
  rename("total_reject" = n)

total_count = 
  sim_results %>% 
  count(beta1) %>% 
    rename("total_pval" = n)
```



_Graph of Effect Size versus Power_

```{r}
total_count = left_join(total_count, reject_count, by = "beta1") %>% 
  mutate(proportion = (total_reject / total_pval)*100) 

  ggplot(total_count, aes(x = beta1, y = proportion)) + geom_line() + labs(title = "Proportion of Times Null was Rejected", x = "true beta", y = "Power") + scale_x_continuous(breaks = c(0,1,2,3,4,5,6))
```






